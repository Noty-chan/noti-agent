
# TASK_MAP.md — карта задач по `noty_specification.md`

## A. Архитектурный каркас (из раздела «Архитектура»)
- [x] Привести проект к модульной структуре `noty/`.
- [x] Разделить ядро на доменные модули (api/context/prompt/mood/tools/memory/thought).
- [x] Добавить transport-слой для реального VK ingestion.
- [x] Подготовить адаптер под Telegram (опциональный режим).



## B. Память и обучение (раздел «Память и обучение»)
- [x] Завести SQLite manager и таблицы из спецификации.
- [x] Добавить обёртку Mem0 (конфиг под Qdrant).
- [x] Добавить jsonl-архив мыслей и событий.
- [x] Реализовать политику TTL для кратковременного состояния.
- [x] Внедрить обновление памяти после каждого ответа (успех/провал).

## C. Фильтрация сообщений (раздел «Фильтрация сообщений»)
- [x] Реализовать эвристический фильтр (быстрый отсев).
- [x] Реализовать embedding-based фильтр.
- [x] Добавить отдельный этап рандомизации и калибровки вероятности реакции.
- [x] Собирать метрики точности фильтра и стоимости API.

## D. Характер и адаптация (раздел «Характер и адаптация»)
- [x] Реализовать модульный Prompt Builder.
- [x] Добавить версионность personality слоёв.
- [x] Реализовать MoodManager и энергию.
- [x] Добавить автоадаптацию тона по накопленной статистике и отношениям.

## E. Управление чатами / Tools (разделы «Управление чатами», «Команды на ПК»)
- [x] Реализовать безопасный `SafeToolExecutor`.
- [x] Добавить реестр tools и подтверждение опасных команд.
- [x] Добавить заготовки chat-control и pc commands.
- [x] Внедрить real-platform вызовы бан/мут/удаление сообщений.
- [x] Добавить журнал действий модерации в `data/logs/actions`.
- [x] Добавить post-processing tool execution pipeline (ResponseProcessor + tools_used/relationship/mood updates).
- [x] Стандартизировать статусы SafeToolExecutor и добавить idempotency подтверждений.

## F. Внутренний монолог (раздел «Мысленный монолог»)
- [x] Добавить генерацию внутреннего монолога отдельным вызовом.
- [x] Логировать мысли в `data/logs/thoughts/*.jsonl`.
- [x] Добавить контроль качества мыслей и их влияния на стратегию ответа.

## G. Техстек, безопасность, метрики (соответствующие разделы спецификации)
- [x] Подготовить `requirements.txt`, `docker-compose.yml`, `config/*`.
- [x] Добавить централизованный мониторинг latency / token-cost / errors.
- [x] Реализовать аудит опасных команд и откат personality-версий.
- [x] Подготовить тестовый контур (unit + smoke) для основных модулей.

## H. Фазы из плана разработки (1–10)
### Фаза 1: MVP
- [x] Подключить рабочий VK polling/webhook.
- [x] Сквозной сценарий: входящее сообщение -> ответ -> логи.

### Фаза 2: Фильтрация
- [x] Настроить пороги и долю ответа ~20%.

### Фаза 3: Память
- [x] Запоминание outcome каждого взаимодействия.

### Фаза 4: Характер и настроение
- [x] Динамическое влияние истории на стиль ответа.

### Фаза 5: Инструменты
- [ ] Права, подтверждения, модерация и действия в реальном чате.

### Фаза 6: Монолог
- [x] Учет мыслей в выборе стратегий и тональности.

### Фаза 7: Самомодификация
- [x] Approve/reject workflow и rollback personality.

### Фаза 8: Мультичатность
- [ ] Полная изоляция контекста и состояния между чатами.

### Фаза 9: Полировка
- [ ] Оптимизация стоимости и задержек.

### Фаза 10: Telegram
- [x] Завершить адаптер и общий routing слой.

---

## Приоритет следующего итерационного цикла
1. **Фаза 5 — role-based права и guardrails для модерации в реальном чате**  
   Критерий готовности: 100% критичных tool-calls (`ban/mute/delete`) проходят проверку ролей (allow/deny) и пишут структурированный аудит (chat_id, actor_id, decision, reason, trace_id) без пропусков.
2. **Фаза 5 — подтверждения опасных действий и anti-abuse контур**  
   Критерий готовности: для всех high-risk действий включён mandatory confirmation flow (pending -> approved/rejected -> executed/cancelled), доля выполнений без подтверждения = 0% в интеграционных тестах и staging-логах.
3. **Фаза 8 — полная мультичат-изоляция state/memory/context**  
   Критерий готовности: в нагрузочном сценарии на >= 3 одновременных чата зафиксировано 0 случаев кросс-чат утечки (recent context, relationship score, mood/state, memory retrieval) по проверкам trace/log assertions.
4. **Фаза 8 — изоляция tool execution и action logs по chat_id**  
   Критерий готовности: все вызовы tools и записи в `data/logs/actions` содержат `chat_id`; интеграционный тест подтверждает, что tool side-effects и журналы недоступны из другого чата (0 cross-chat side effects).
5. **Фаза 9 — оптимизация стоимости и задержек end-to-end**  
   Критерий готовности: p95 latency полного цикла ответа < 2500 ms, средняя стоимость на сообщение снижена минимум на 20% от текущего baseline, при сохранении целевого respond-rate 20% ± 5%.
