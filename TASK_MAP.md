
# TASK_MAP.md — карта задач по `noty_specification.md`

## A. Архитектурный каркас (из раздела «Архитектура»)
- [x] Привести проект к модульной структуре `noty/`.
- [x] Разделить ядро на доменные модули (api/context/prompt/mood/tools/memory/thought).
- [x] Добавить transport-слой для реального VK ingestion.
- [ ] Подготовить адаптер под Telegram (опциональный режим).

## B. Память и обучение (раздел «Память и обучение»)
- [x] Завести SQLite manager и таблицы из спецификации.
- [x] Добавить обёртку Mem0 (конфиг под Qdrant).
- [x] Добавить jsonl-архив мыслей и событий.
- [x] Реализовать политику TTL для кратковременного состояния.
- [x] Внедрить обновление памяти после каждого ответа (успех/провал).

## C. Фильтрация сообщений (раздел «Фильтрация сообщений»)
- [x] Реализовать эвристический фильтр (быстрый отсев).
- [x] Реализовать embedding-based фильтр.
- [x] Добавить отдельный этап рандомизации и калибровки вероятности реакции.
- [x] Собирать метрики точности фильтра и стоимости API.

## D. Характер и адаптация (раздел «Характер и адаптация»)
- [x] Реализовать модульный Prompt Builder.
- [x] Добавить версионность personality слоёв.
- [x] Реализовать MoodManager и энергию.
- [x] Добавить автоадаптацию тона по накопленной статистике и отношениям.

## E. Управление чатами / Tools (разделы «Управление чатами», «Команды на ПК»)
- [x] Реализовать безопасный `SafeToolExecutor`.
- [x] Добавить реестр tools и подтверждение опасных команд.
- [x] Добавить заготовки chat-control и pc commands.
- [x] Внедрить real-platform вызовы бан/мут/удаление сообщений.
- [x] Добавить журнал действий модерации в `data/logs/actions`.

## F. Внутренний монолог (раздел «Мысленный монолог»)
- [x] Добавить генерацию внутреннего монолога отдельным вызовом.
- [x] Логировать мысли в `data/logs/thoughts/*.jsonl`.
- [x] Добавить контроль качества мыслей и их влияния на стратегию ответа.

## G. Техстек, безопасность, метрики (соответствующие разделы спецификации)
- [x] Подготовить `requirements.txt`, `docker-compose.yml`, `config/*`.
- [x] Добавить централизованный мониторинг latency / token-cost / errors.
- [x] Реализовать аудит опасных команд и откат personality-версий.
- [x] Подготовить тестовый контур (unit + smoke) для основных модулей.

## H. Фазы из плана разработки (1–10)
### Фаза 1: MVP
- [x] Подключить рабочий VK polling/webhook.
- [x] Сквозной сценарий: входящее сообщение -> ответ -> логи.

### Фаза 2: Фильтрация
- [x] Настроить пороги и долю ответа ~20%.

### Фаза 3: Память
- [x] Запоминание outcome каждого взаимодействия.

### Фаза 4: Характер и настроение
- [x] Динамическое влияние истории на стиль ответа.

### Фаза 5: Инструменты
- [ ] Права, подтверждения, модерация и действия в реальном чате.

### Фаза 6: Монолог
- [x] Учет мыслей в выборе стратегий и тональности.

### Фаза 7: Самомодификация
- [x] Approve/reject workflow и rollback personality.

### Фаза 8: Мультичатность
- [ ] Полная изоляция контекста и состояния между чатами.

### Фаза 9: Полировка
- [ ] Оптимизация стоимости и задержек.

### Фаза 10: Telegram
- [ ] Завершить адаптер и общий routing слой.

---

## Приоритет следующего итерационного цикла
1. Реальный VK ingestion + сквозной MVP.
2. Метрики фильтрации и стоимости.
3. Автообновление памяти/отношений после ответа.
4. Тестовый контур.

# Карта задач проекта Noti

Источник: `noty_specification.md` (раздел «План разработки», фазы 1–10).

## 0) Базовая декомпозиция (выполнено)
- [x] Разделить `noty_core_code.py` на подмодули-обёртки в `noty_core/`.
- [x] Добавить `AGENTS.md` с рабочими правилами.
- [x] Зафиксировать карту задач в `TASK_MAP.md`.

## 1) MVP ядра (Фаза 1)
- [x] Поднять простой polling/ingestion для VK.
- [ ] Добавить базовый prompt и генерацию ответа.
- [ ] Подключить `APIRotator` для устойчивости к rate limit.
- [x] Сохранить минимальные логи взаимодействий.

## 2) Фильтрация сообщений (Фаза 2)
- [ ] Реализовать 3-этапный фильтр (эвристика → embeddings → рандомизация).
- [ ] Калибровать пороги интересности на тестовой выборке.
- [ ] Ввести метрику `respond_rate` (~20% целевой ориентир).

## 3) Память и хранение (Фаза 3)
- [ ] Поднять SQLite-схему (`users`, `chats`, `interactions`, `moderation`, `prompt_versions`).
- [ ] Подключить Mem0/Qdrant для семантической памяти.
- [ ] Реализовать `.jsonl`-архив событий и мыслей.

## 4) Характер и настроение (Фаза 4)
- [ ] Внедрить модульный prompt builder со слоями.
- [ ] Подключить `MoodManager` и правила переходов состояний.
- [ ] Адаптировать тон к score отношений с пользователем.

## 5) Инструменты управления чатом (Фаза 5)
- [ ] Реализовать безопасный реестр tools (ban/mute/warn и т.д.).
- [ ] Добавить проверки прав: owner/admin/private.
- [ ] Для опасных действий включить обязательное подтверждение.

## 6) Внутренний монолог (Фаза 6)
- [ ] Генерировать «мысли» отдельной дешёвой моделью.
- [ ] Логировать мысли в `data/logs/thoughts/*.jsonl`.
- [ ] Использовать мысли как скрытый слой принятия решения.

## 7) Самомодификация (Фаза 7)
- [x] Вести версионность personality layer.
- [x] Реализовать approve/reject workflow для новых версий.
- [x] Добавить безопасный откат на предыдущую стабильную версию.

## 8) Мультичатность (Фаза 8)
- [ ] Нормализовать контекст и память по `chat_id`.
- [ ] Изолировать активное состояние чатов.
- [ ] Оптимизировать выборку релевантной истории.

## 9) Полировка и оптимизация (Фаза 9)
- [ ] Ввести метрики: latency, token cost, error rate, quality.
- [ ] Сократить стоимость вызовов без деградации качества.
- [ ] Покрыть ключевые пути тестами.

## 10) Telegram-расширение (Фаза 10, опционально)
- [ ] Добавить transport-адаптер Telegram.
- [ ] Сохранить общий core без дублирования бизнес-логики.
- [ ] Унифицировать мониторинг и логи по платформам.

---

## Приоритеты на ближайший спринт
1. Фаза 1 (MVP ядра).
2. Фаза 2 (фильтрация, чтобы ограничить API-расход).
3. Фаза 3 (память и структура данных).
